@model acsa_web.Models.ViewModels.AdminUserSearchVm
@{
    ViewData["Title"] = "Manage Users";
    var hasQuery = !string.IsNullOrWhiteSpace(Model.Username);
}

<style>
    .mh-scroll {
        overflow: auto;
        scrollbar-width: none;
        -ms-overflow-style: none;
    }

        .mh-scroll::-webkit-scrollbar {
            width: 0;
            height: 0;
        }
</style>

@if (TempData["ErrorMessage"] is string err)
{
    <div class="alert alert-error mb-4"><span>@err</span></div>
}
@if (TempData["SuccessMessage"] is string ok)
{
    <div class="alert alert-success mb-4"><span>@ok</span></div>
}

<div class="flex items-end justify-between mb-5">
    <div>
        <h1 class="text-2xl font-bold">Manage Users</h1>
        <div class="text-sm opacity-70 mt-1">Search by username, then manage the account.</div>

        @if (hasQuery && Model.Results != null)
        {
            <div class="text-xs opacity-60 mt-2">
                Found @Model.Results.Count result@(Model.Results.Count == 1 ? "" : "s") for “@Model.Username”.
            </div>
        }
    </div>
</div>

<div class="card bg-base-100 border border-base-300 shadow-lg mb-6">
    <div class="card-body p-6">
        <form method="post" class="grid grid-cols-1 md:grid-cols-12 gap-3 items-end">
            @Html.AntiForgeryToken()

            <div class="md:col-span-12 form-control">
                <label class="label pb-1">
                    <span class="label-text">Username</span>
                </label>

                <div class="join w-full">
                    <div class="join-item flex items-center gap-2 px-3 border border-base-300 bg-base-100 rounded-l-btn w-full">
                        <svg xmlns="http://www.w3.org/2000/svg"
                             class="h-4 w-4 opacity-60"
                             fill="none"
                             viewBox="0 0 24 24"
                             stroke="currentColor">
                            <path stroke-linecap="round"
                                  stroke-linejoin="round"
                                  stroke-width="2"
                                  d="M21 21l-4.35-4.35m1.85-5.65a7 7 0 11-14 0 7 7 0 0114 0z" />
                        </svg>

                        <input class="input input-bordered border-0 h-12 w-full px-0 focus:outline-none"
                               name="Username"
                               value="@Model.Username"
                               placeholder="Type a username…"
                               autocomplete="off" />
                    </div>

                    <div class="flex items-center gap-2 ml-3">
                        <button class="btn btn-primary h-12 px-8 shadow-md"
                                type="submit">
                            Search
                        </button>

                        @if (!string.IsNullOrWhiteSpace(Model.Username))
                        {
                            <a class="btn btn-ghost h-12 px-6 text-error hover:bg-error/10"
                               asp-controller="Admin"
                               asp-action="Users">
                                Clear
                            </a>
                        }
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>

@if (Model.Results != null && Model.Results.Any())
{
    <div class="card bg-base-100 border border-base-300 shadow-lg">
        <div class="card-body p-0">

            <div class="px-6 py-4 border-b border-base-300 flex items-center justify-between">
                <div class="font-semibold">Results</div>
                <div class="text-xs opacity-60">@Model.Results.Count user@(Model.Results.Count == 1 ? "" : "s")</div>
            </div>

            <div class="overflow-x-auto">
                <div class="mh-scroll rounded-2xl border border-transparent max-h-[600px]">

                    <table class="table w-full">
                        <thead class="text-xs uppercase opacity-70 bg-base-100">
                            <tr>
                                <th>User</th>
                                <th>Email</th>
                                <th class="w-[140px]">Status</th>
                                <th class="w-[130px] text-right">Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var u in Model.Results)
                            {
                                var username = u.UserName ?? "(no username)";
                                <tr class="hover">
                                    <td>
                                        <div class="flex items-center gap-3">
                                            <div class="avatar placeholder">
                                                <div class="w-9 rounded-full bg-base-200 text-base-content/70">
                                                    <span class="text-xs font-semibold">
                                                        @(username.Length >= 2
                                                                                                        ? username.Substring(0, 2).ToUpperInvariant()
                                                                                                        : username.ToUpperInvariant())
                                                    </span>
                                                </div>
                                            </div>

                                            <div class="min-w-0">
                                                <div class="font-semibold truncate max-w-[260px]">@username</div>
                                            </div>
                                        </div>
                                    </td>

                                    <td class="truncate max-w-[420px]">
                                        @u.Email
                                    </td>

                                    <td>
                                        @if (u.IsBanned)
                                        {
                                            <span class="badge badge-error badge-outline">Banned</span>
                                        }
                                        else if (!u.IsAccountLinkedWithGame)
                                        {
                                            <span class="badge badge-warning badge-outline">Unverified</span>
                                        }
                                        else
                                        {
                                            <span class="badge badge-success badge-outline">Verified</span>
                                        }
                                    </td>

                                    <td class="text-right">
                                        <a class="btn btn-sm btn-outline"
                                           asp-controller="Admin"
                                           asp-action="UserDetails"
                                           asp-route-id="@u.Id">
                                            Manage
                                        </a>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>

                </div>
            </div>

            <div class="px-6 py-4 border-t border-base-300 text-xs opacity-60">
                Tip: Click “Manage” to view user logs, match history, and ban/unban.
            </div>
        </div>
    </div>
}
else if (hasQuery)
{
    <div class="alert alert-info">
        <span>No users found.</span>
    </div>
}
